from random import shuffle

from src.bot.bot import Bot
from src.const.cell import CellType
from src.const.config import BOTS_COUNT, MIN_BOTS, BOTS_CLONES, ENERGY
from src.data.data_exporter import PsqlDataExporter


class BootPool:

    def __init__(self, world):
        self.world = world
        self.bots = create_bots(world)
        self.epoch = 0
        self.ticks = 0
        self.data_exporter = PsqlDataExporter()

    def execute_bots_commands(self):
        dead_bots = set()
        bots_as_list = list(self.bots)
        shuffle(bots_as_list)
        for bot in bots_as_list:
            bot.id = self.data_exporter.save_bot(bot)
            if len(self.bots) - len(dead_bots) <= MIN_BOTS:
                break
            bot.execute_commands()
            if not bot.is_alive():
                dead_bots.add(bot)

        for bot in dead_bots:
            self.world.update_cell(bot.location, CellType.EMPTY)
            self.bots.remove(bot)
            bot.drop_epoch = self.epoch
            self.data_exporter.update_bot(bot)
            self.data_exporter.save_bot_epoch_ticks(self.epoch, bot.ticks)
        self.ticks += 1

    def clone_bots(self):
        new_bots = set()

        for bot in self.bots:
            self.data_exporter.save_bot_epoch_ticks(self.epoch, bot.ticks)
            if bot.energy < ENERGY:
                bot.energy = ENERGY
            for i in range(BOTS_CLONES):
                cloned_bot = bot.clone()
                cloned_bot.created_epoch = self.epoch
                location = self.world.rand_free_location()
                cloned_bot.location = location
                self.world.put_cell(location, cloned_bot)
                new_bots.add(cloned_bot)

        self.bots.update(new_bots)
        self.data_exporter.save_epoch_ticks(self.epoch, self.ticks)
        self.data_exporter.save_epoch_food_poison(self.epoch, self.world.food_amount(), self.world.poison_amount())
        self.epoch += 1
        self.ticks = 0

    def __len__(self):
        return len(self.bots)


def create_bots(world):
    bots = set()
    for i in range(BOTS_COUNT):
        location = world.rand_free_location()
        bot = Bot(location, world)
        world.put_cell(location, bot)
        bots.add(bot)
    return bots


def create_bots_v2(world):
    bots = set()
    for gene_group in gene_groups:
        location = world.rand_free_location()
        bot = Bot(location, world)
        bot.genes.genes = gene_group
        world.put_cell(location, bot)
        bots.add(bot)
    return bots


gene_groups = [
    [31,60,48,48,28,2,3,34,8,53,1,52,33,55,40,28,44,14,54,20,60,17,58,56,3,17,51,18,30,5,29,54,36,56,42,19,47,42,25,3,11,61,11,29,13,20,13,59,16,30,24,21,60,54,59,43,13,61,7,47,26,45,6,29],
    [39,53,27,11,35,11,34,35,9,22,56,19,14,3,56,62,2,19,46,2,6,34,22,39,35,25,9,3,59,52,48,24,34,27,29,19,36,56,50,3,11,61,14,29,13,20,61,15,30,32,24,21,14,54,15,43,53,35,43,60,20,23,40,33],
    [39,53,27,53,53,47,36,35,34,61,10,5,14,13,56,62,28,19,46,2,24,1,37,14,6,25,9,10,59,52,48,58,34,39,48,19,58,56,50,3,11,61,14,29,13,20,61,14,30,32,24,21,44,54,10,43,53,35,12,59,20,46,40,33],
    [39,53,27,53,53,54,36,35,8,51,36,5,14,3,56,62,55,19,46,2,58,58,12,39,6,25,9,55,59,52,48,10,34,59,29,19,36,56,50,3,11,61,53,29,13,20,61,14,30,32,24,21,44,54,35,43,53,35,12,60,20,46,40,33],
    [21,63,61,35,12,19,29,41,37,42,54,48,49,6,63,36,44,38,10,33,29,35,25,45,24,36,33,61,27,34,33,23,14,1,26,19,46,42,25,3,11,61,11,29,13,20,61,59,24,30,24,21,13,54,6,43,53,61,48,47,57,45,21,6],
    [21,31,46,62,55,30,45,45,46,20,17,33,61,18,56,49,44,38,39,10,22,35,8,38,24,25,17,3,27,52,44,24,14,38,30,19,38,42,50,3,11,61,8,29,13,20,61,17,24,30,24,21,30,54,6,43,53,61,62,47,57,45,17,10],
    [45,7,14,25,10,34,51,15,56,18,4,16,42,9,20,31,44,61,36,48,40,12,47,14,9,43,0,31,36,3,47,49,11,1,44,19,43,42,25,3,11,61,54,29,13,20,61,52,24,30,24,21,43,56,9,43,53,61,29,48,56,45,43,1],
    [45,60,20,57,10,18,46,26,48,1,56,1,48,38,50,22,44,3,13,13,43,23,47,44,5,48,61,16,35,48,12,38,46,21,50,19,35,42,25,3,11,61,44,29,13,20,61,62,24,30,24,21,1,56,9,43,53,61,52,3,8,45,1,6],
    [53,6,21,1,9,33,14,4,26,7,61,35,36,31,28,40,40,49,9,38,26,25,61,41,54,25,53,19,41,58,48,16,32,62,21,19,18,56,61,3,62,61,46,27,13,20,46,29,24,24,30,21,52,54,46,43,51,61,59,0,13,22,59,44],
    [45,59,40,16,60,19,29,32,37,20,54,1,49,42,63,36,44,8,10,35,29,32,54,33,12,34,8,61,7,34,59,32,14,1,58,19,43,42,25,3,11,61,11,29,13,20,61,59,24,30,24,21,24,54,35,43,53,61,48,47,6,45,21,46],
    [21,22,13,35,12,19,29,41,37,20,54,48,49,42,63,36,44,44,10,33,29,25,25,12,24,34,8,61,47,34,26,23,14,1,2,19,46,42,25,3,11,61,11,29,13,20,61,59,24,30,24,21,13,54,35,43,53,61,48,47,13,45,21,6],
    [21,31,61,62,55,30,29,41,62,20,8,48,49,44,56,49,44,38,39,63,22,35,8,50,24,25,16,61,27,60,44,23,14,53,4,19,46,42,25,3,11,61,11,29,13,20,61,17,24,30,24,21,30,54,6,43,53,61,62,47,57,45,21,6],
    [41,31,46,62,27,54,45,45,46,21,17,38,61,20,56,49,44,38,39,49,53,35,12,38,33,25,17,44,27,52,44,24,14,38,30,19,3,42,50,3,11,61,55,29,13,20,61,17,48,30,24,21,30,54,26,43,53,61,62,47,57,45,26,18],
    [39,53,27,53,53,47,36,35,34,61,1,5,14,45,56,62,28,19,46,2,24,1,37,28,6,25,9,55,59,52,48,58,34,59,48,19,58,56,50,3,11,61,14,29,13,20,61,14,30,32,24,21,44,54,10,43,53,35,12,32,20,46,40,33],
    [45,40,20,57,10,18,48,15,48,8,4,47,48,33,50,22,44,12,13,13,43,23,47,14,10,48,61,43,35,59,12,37,46,21,54,19,45,42,25,3,11,61,13,29,13,20,61,62,24,30,24,21,1,46,9,43,53,61,12,53,8,45,1,32],
    [54,60,20,57,10,47,27,30,48,23,56,9,48,38,24,8,44,25,42,13,41,52,47,44,5,48,61,43,43,12,24,58,46,0,22,19,49,42,25,3,11,61,56,29,13,20,61,62,24,30,24,21,37,56,29,43,53,61,47,60,14,45,1,6],
    [53,60,20,57,10,34,2,26,33,43,56,0,49,31,50,59,44,3,13,13,53,36,47,34,49,9,50,26,35,48,55,27,14,37,50,19,35,42,25,3,11,61,60,29,13,20,61,62,24,30,24,21,48,56,57,43,53,61,21,3,8,45,34,6],
    [42,19,11,39,49,22,3,55,19,29,19,30,33,4,3,63,44,9,5,16,31,20,37,25,29,17,61,18,4,3,31,54,36,44,2,19,43,42,25,3,11,61,11,29,13,20,13,59,16,30,24,21,30,54,59,43,53,61,55,5,13,45,35,2],
    [59,6,1,21,60,34,24,33,0,39,9,63,57,9,10,36,44,0,58,6,62,57,49,7,4,34,20,11,47,3,52,17,10,3,1,19,43,42,25,3,11,61,11,29,13,20,61,59,24,30,24,21,27,54,34,43,53,61,50,47,13,45,58,36],
    [21,31,61,62,55,46,29,41,37,20,11,48,49,35,56,36,44,38,61,33,22,35,25,14,24,25,16,61,27,60,44,23,14,14,4,19,46,42,25,3,11,61,11,29,13,20,61,59,24,30,24,21,14,54,6,43,53,61,62,47,57,45,21,6],
    [53,33,16,62,54,12,30,1,21,37,38,47,29,31,28,40,40,49,32,38,26,45,61,41,33,25,53,50,3,58,48,57,5,15,8,19,18,56,61,3,62,61,46,27,13,20,46,29,24,24,30,21,58,54,46,43,51,61,59,53,46,4,51,50],
    [45,7,14,25,10,34,18,15,16,18,4,16,12,9,16,31,44,42,36,58,40,12,47,14,9,43,4,31,37,3,52,23,15,1,44,19,43,42,25,3,11,61,54,29,13,20,61,52,24,30,24,21,43,56,9,43,53,61,29,48,56,45,43,9],
    [21,31,46,62,55,7,41,45,1,20,36,33,61,18,56,49,44,38,39,10,22,3,8,38,24,25,17,3,16,52,44,52,14,38,49,19,38,42,50,3,11,61,8,29,13,20,61,23,24,30,24,21,30,54,13,43,53,61,62,47,57,45,17,11],
    [28,60,20,57,10,62,46,26,33,43,56,24,48,1,50,25,44,3,13,13,53,36,47,44,5,9,61,26,35,48,55,27,14,21,50,19,35,42,25,3,11,61,44,29,13,20,61,62,24,30,24,21,1,56,57,43,53,61,21,3,8,45,1,6],
    [45,7,12,49,10,61,27,15,16,18,4,35,10,16,23,31,44,62,36,52,27,12,47,14,9,3,0,43,36,3,46,61,46,1,28,19,43,42,25,3,11,61,54,29,13,20,61,52,24,30,24,21,11,56,17,43,53,61,3,48,10,45,43,6],
    [21,31,46,62,55,30,29,45,62,20,17,5,61,18,56,49,44,38,39,10,22,35,8,38,24,25,17,3,27,52,44,24,14,38,30,19,52,42,25,3,11,61,8,29,13,20,61,17,24,30,24,21,30,54,6,43,53,61,62,47,57,45,17,10],
    [39,53,27,53,35,11,34,35,9,22,56,19,14,3,56,62,2,19,46,2,49,34,22,39,6,25,9,3,59,52,48,24,34,59,29,19,36,56,50,3,11,61,14,29,13,20,61,15,30,32,24,21,44,54,15,43,53,35,43,60,20,23,40,33],
    [21,31,61,62,55,46,29,41,37,20,11,48,49,44,56,49,44,38,61,63,22,35,8,14,24,25,16,61,27,60,44,23,14,53,4,19,46,42,25,3,11,61,11,29,13,20,61,17,24,30,24,21,14,54,6,43,53,61,62,47,57,45,21,6],
    [42,19,3,39,49,22,3,55,19,29,30,30,33,4,3,63,44,9,5,16,31,20,37,25,29,17,37,18,4,3,31,54,36,44,13,19,43,42,25,3,11,61,11,29,13,20,13,59,16,30,24,21,30,54,59,43,53,61,55,20,13,45,35,1],
    [21,63,61,35,55,7,29,41,37,20,11,48,49,42,63,36,44,38,10,33,29,35,25,45,24,25,8,61,27,34,44,23,14,14,4,19,46,42,25,3,11,61,11,29,13,20,61,59,24,30,24,21,13,54,6,43,53,61,62,47,57,45,21,6],
    [28,60,20,57,10,62,46,26,33,36,56,24,48,1,50,25,44,3,13,13,43,36,47,44,5,48,61,16,35,48,55,27,26,21,50,19,35,42,25,3,11,61,44,29,13,20,61,62,24,30,24,21,1,56,57,43,53,61,52,3,8,45,1,6],
    [45,59,13,35,60,18,29,32,16,20,54,37,49,42,7,36,44,22,10,35,59,25,57,7,12,36,8,11,56,62,59,32,14,1,58,19,31,42,25,3,11,61,11,29,13,20,61,59,24,30,24,21,24,54,3,43,53,61,17,47,9,45,60,6],
    [21,22,13,35,12,19,29,30,37,4,54,48,49,42,63,36,44,44,10,33,29,25,25,12,24,34,8,61,47,34,5,23,14,1,2,19,0,42,25,3,11,61,11,29,13,20,61,59,24,30,24,21,13,54,21,43,53,61,48,47,13,45,21,5],
    [53,4,53,1,26,33,33,4,13,7,61,35,36,31,21,40,40,9,9,33,26,31,51,41,54,25,53,18,41,63,48,18,32,62,21,19,18,56,61,3,62,61,46,40,13,20,41,29,24,24,30,21,24,54,46,43,51,61,63,29,36,61,59,35],
    [45,13,0,21,60,34,53,32,0,20,54,1,57,42,10,17,44,22,10,53,53,33,11,7,12,34,8,11,47,3,52,32,14,44,1,19,43,42,25,3,11,61,11,29,13,20,61,59,24,30,24,21,40,54,35,43,53,61,48,47,13,45,58,6],
    [21,57,13,17,17,19,29,32,37,20,54,1,49,42,63,36,44,44,10,35,29,25,25,3,24,34,8,61,47,34,7,32,29,1,2,19,46,42,25,3,11,61,11,29,13,20,61,59,31,30,24,21,13,54,35,43,53,61,48,47,13,45,21,6],
    [10,53,27,53,53,54,36,35,8,51,36,5,11,3,56,62,55,19,46,2,58,58,20,39,6,25,9,55,59,52,48,10,34,59,29,19,36,56,50,3,11,61,55,29,13,20,61,14,30,32,24,21,44,54,9,43,53,35,12,23,20,46,40,33],
    [54,12,20,57,10,47,36,40,11,23,4,27,48,38,24,22,44,30,46,13,54,51,35,44,5,48,61,43,43,12,24,58,46,21,22,19,49,42,25,3,11,61,32,29,13,20,61,62,24,30,24,21,1,56,17,43,53,61,47,60,14,45,1,6],
    [53,19,42,54,25,22,17,21,19,51,30,30,33,3,16,63,44,31,51,16,53,20,37,25,19,34,13,37,4,3,31,54,36,44,20,19,43,42,25,3,11,61,26,29,13,20,13,59,24,30,24,21,47,54,61,43,53,61,55,11,7,45,35,1],
    [42,19,3,39,49,22,3,21,19,6,30,30,33,4,3,63,44,9,20,16,31,20,37,25,1,17,37,18,4,3,31,54,36,44,13,19,43,42,25,3,11,61,11,29,13,20,13,59,24,30,24,21,30,54,48,43,53,61,55,20,13,45,35,1],
    [45,7,14,25,10,34,27,15,42,18,4,16,10,9,20,31,44,61,36,48,40,12,47,14,9,43,0,31,36,3,47,49,11,1,44,19,43,42,25,3,11,61,54,29,13,20,61,52,24,30,24,21,43,56,17,43,53,61,29,48,27,45,43,6],
    [13,10,14,18,10,0,40,15,47,18,2,16,61,9,20,31,44,61,36,26,49,14,47,14,9,43,24,31,36,15,47,54,11,25,44,19,43,42,25,3,11,61,54,29,13,20,61,52,24,30,24,21,43,56,9,43,53,61,15,48,31,45,14,1],
    [21,26,9,59,33,49,2,38,30,40,55,46,36,10,11,49,44,38,62,26,42,53,8,50,24,13,16,15,58,21,38,17,44,38,34,19,21,40,25,3,11,61,25,29,13,20,61,17,24,30,24,21,1,54,6,43,51,61,62,21,57,45,17,10],
    [33,53,15,20,34,39,2,0,55,63,7,53,54,31,43,40,40,31,13,33,59,5,61,63,13,25,53,29,36,58,48,58,7,16,1,19,18,56,50,3,62,61,46,11,13,20,47,29,24,24,30,21,23,54,40,43,51,61,19,53,36,21,22,36],
    [8,25,46,62,55,54,41,45,46,20,17,23,61,18,56,49,44,38,39,10,22,32,8,38,6,25,17,3,27,52,5,24,14,38,30,19,38,42,50,3,11,61,0,29,13,20,61,17,24,30,24,21,30,54,6,43,53,61,62,47,28,45,17,10],
    [52,19,42,54,43,22,17,11,19,51,30,30,33,3,16,63,44,9,51,16,53,20,37,25,19,34,13,37,4,3,31,54,36,44,20,19,43,42,25,3,11,61,11,29,13,20,13,59,24,30,24,21,47,54,61,43,53,61,55,11,13,45,35,1],
    [46,57,13,17,17,19,29,32,37,20,54,53,3,42,63,36,44,44,10,35,29,25,24,3,24,34,8,20,47,34,7,32,29,1,2,19,46,42,25,3,11,61,11,29,13,20,61,59,31,30,24,21,13,54,35,43,53,61,48,47,13,45,54,6],
    [45,7,14,25,10,34,51,15,56,18,4,16,12,9,20,31,44,61,36,48,40,12,47,14,9,43,4,31,37,3,52,23,15,1,44,19,43,42,25,3,11,61,54,29,13,20,61,52,24,30,24,21,43,56,9,43,53,61,29,48,56,45,43,1],
    [39,53,27,53,53,47,36,35,34,61,45,5,14,13,56,62,28,19,46,2,24,1,37,14,6,25,9,10,62,52,48,58,34,39,53,19,58,56,50,3,11,61,14,29,13,20,61,14,30,32,24,21,44,54,30,43,53,35,12,54,20,46,40,16],
    [21,31,46,62,55,30,29,14,62,20,8,48,58,44,56,49,44,38,39,63,22,35,8,50,24,25,17,21,27,53,44,23,14,53,4,19,46,42,25,3,11,61,11,29,13,20,61,17,24,30,24,21,30,54,6,43,53,61,62,47,57,45,21,6],
    [31,60,48,48,28,2,3,34,8,53,1,31,33,55,40,28,44,62,54,20,60,50,58,56,3,17,51,18,30,5,29,54,36,56,42,19,47,42,25,3,11,61,11,29,13,20,13,59,16,30,24,21,60,54,59,43,13,61,7,18,37,45,47,29],
    [33,53,15,20,63,39,18,0,9,63,54,53,19,31,43,40,40,31,13,33,55,9,61,63,13,25,53,29,36,58,48,45,22,16,61,19,54,56,50,3,62,61,46,27,13,20,47,29,24,24,30,21,11,54,46,43,51,61,19,8,36,51,22,36],
    [21,22,13,1,12,19,25,41,37,20,55,23,49,42,63,13,44,44,10,33,29,25,25,12,24,61,8,61,47,34,26,23,35,1,2,19,41,42,25,3,11,61,11,29,13,20,61,18,24,30,24,21,13,54,35,43,53,61,42,47,13,45,48,6],
    [45,60,20,57,10,18,51,1,48,8,56,49,48,38,50,22,44,3,13,13,43,23,47,44,5,48,61,43,35,39,12,37,46,21,22,19,41,42,25,3,11,61,44,29,13,20,61,62,24,30,24,21,1,56,9,43,53,61,47,53,8,45,1,6],
    [56,60,0,22,63,30,54,6,46,20,17,33,12,55,56,49,44,16,32,10,22,13,8,38,6,25,17,3,62,52,44,60,62,58,30,19,15,42,50,3,11,61,9,29,13,20,61,17,24,30,24,21,48,54,6,43,53,61,62,47,49,45,40,10],
    [39,53,27,53,53,47,36,35,34,61,1,5,14,3,56,62,28,19,46,2,58,58,37,21,6,25,9,55,59,52,48,58,34,59,29,19,36,56,50,3,11,61,14,29,13,20,61,14,30,32,24,21,44,54,10,43,53,35,12,32,20,46,40,33],
    [45,60,20,57,10,18,51,54,48,23,56,49,48,38,50,22,44,3,13,13,27,52,47,44,5,48,61,43,35,12,15,9,46,21,22,19,41,42,25,3,11,61,56,29,13,20,61,62,24,30,24,21,1,56,9,43,53,61,47,60,8,45,1,6],
    [45,59,13,35,60,18,29,32,37,20,54,37,49,42,7,36,44,22,10,35,59,25,27,7,12,58,8,11,56,62,59,32,14,1,58,19,31,42,25,3,11,61,11,29,13,20,61,59,24,30,24,21,24,54,3,43,53,61,48,47,13,45,60,6],
    [45,7,14,25,10,34,18,15,16,18,4,16,12,9,16,31,44,42,36,58,40,12,46,14,9,16,20,31,25,3,52,23,15,1,44,19,43,42,25,3,11,61,61,29,13,20,61,52,24,30,24,21,43,56,9,43,53,61,5,48,56,45,43,9],
    [53,55,21,1,52,42,14,4,26,58,61,35,45,31,28,40,40,49,9,48,22,27,8,41,54,25,53,19,41,58,48,22,32,62,21,19,18,37,61,3,62,61,46,27,13,20,32,29,24,24,30,21,52,54,46,43,51,61,59,0,13,0,59,29],
    [54,60,0,57,10,47,59,43,48,23,17,9,48,38,61,22,44,25,13,13,41,52,47,41,5,48,46,43,43,12,24,58,46,21,22,19,29,42,25,3,11,61,56,29,13,20,61,62,24,30,24,21,14,56,29,43,53,61,47,24,45,45,1,6],
    [53,33,30,29,54,48,30,1,21,37,38,47,36,31,28,40,40,49,32,38,26,45,61,41,54,25,53,50,3,58,48,38,32,62,8,19,18,56,61,3,62,61,46,27,13,20,46,29,24,24,30,21,58,54,46,43,51,61,59,53,13,4,59,44],
    [21,63,61,35,12,19,29,41,37,20,54,48,49,42,63,36,44,38,10,33,29,35,25,45,24,34,8,61,27,34,44,23,14,1,4,19,46,42,25,3,11,61,11,29,13,20,61,59,24,30,24,21,13,54,6,43,53,61,48,47,57,45,21,6],
    [53,8,53,1,40,63,33,4,44,7,61,35,36,31,28,40,40,9,9,50,2,31,61,41,54,25,53,45,41,58,48,18,32,62,21,19,18,56,61,3,62,61,46,27,13,20,41,29,24,24,30,21,41,54,46,43,51,61,53,0,36,22,59,35]
]